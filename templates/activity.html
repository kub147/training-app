<!DOCTYPE html>
<html>
<head>
    <title>{{ tx('Szczeg√≥≈Çy aktywno≈õci','Activity details') }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="">
    </head>
<body class="activity-page">
    <div class="container">
        <header>
            <div class="header-row">
                <h1>{{ tx('Szczeg√≥≈Çy aktywno≈õci','Activity details') }}</h1>
            </div>
            <div class="header-actions">
                                {% include "_theme_toggle.html" %}
                <a class="btn btn-outline" href="/">{{ t('nav_panel') }}</a>
                <a class="btn btn-outline" href="/history">{{ tx('Historia','History') }}</a>
            </div>
        </header>

        <div class="main-card">
            <div class="card-header header-{{activity.activity_type}} {% if activity.activity_type not in ['run','ride','swim','weighttraining', 'workout', 'walk'] %}header-default{% endif %}">
                <span class="activity-icon">
                    {% if activity.activity_type == 'run' %}üèÉ
                    {% elif activity.activity_type == 'ride' %}üö¥
                    {% elif activity.activity_type == 'swim' %}üèä
                    {% elif activity.activity_type in ['weighttraining', 'workout'] %}üèãÔ∏è
                    {% elif activity.activity_type == 'walk' %}üö∂
                    {% else %}üèÖ{% endif %}
                </span>
                <h1 class="activity-title">{{ activity_label(activity.activity_type) }}</h1>
                <div class="activity-date">{{ format_dt(activity.start_time, 'long') }} ‚Ä¢ {{ activity.start_time.strftime('%H:%M') }}</div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">{{ tx('Czas trwania','Duration') }}</div>
                    <div class="stat-value">
                        {{ activity.duration // 60 }}<span class="stat-unit">m</span>
                        {{ activity.duration % 60 }}<span class="stat-unit">s</span>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">{{ tx('Dystans','Distance') }}</div>
                    <div class="stat-value">
                        {{ (activity.distance / 1000)|round(2) }}<span class="stat-unit">km</span>
                    </div>
                </div>

                {% if activity.avg_hr %}
                <div class="stat-item">
                    <div class="stat-label">{{ tx('≈ör. Tƒôtno','Avg HR') }}</div>
                    <div class="stat-value">
                        {{ activity.avg_hr }}<span class="stat-unit">bpm</span>
                    </div>
                </div>
                {% endif %}

                {% if activity.activity_type == 'run' and activity.distance > 0 %}
                    <div class="stat-item">
                        <div class="stat-label">{{ tx('≈ör. Tempo','Avg pace') }}</div>
                        <div class="stat-value">
                            {% set pace_decimal = (activity.duration / 60) / (activity.distance / 1000) %}
                            {% set pace_min = pace_decimal|int %}
                            {% set pace_sec = ((pace_decimal - pace_min) * 60)|int %}
                            {{ pace_min }}:{{ "%02d" % pace_sec }}<span class="stat-unit">/km</span>
                        </div>
                    </div>
                {% elif activity.activity_type == 'ride' and activity.duration > 0 %}
                    <div class="stat-item">
                        <div class="stat-label">{{ tx('≈ör. Prƒôdko≈õƒá','Avg speed') }}</div>
                        <div class="stat-value">
                            {{ ((activity.distance / 1000) / (activity.duration / 3600))|round(1) }}<span class="stat-unit">km/h</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if metric_cards %}
        <div class="main-card">
            <div class="card-subtitle">üìä {{ tx('Statystyki z Garmina','Garmin stats') }}</div>
            <div class="stats-grid stats-grid--dense">
                {% for item in metric_cards %}
                <div class="stat-item">
                    <div class="stat-label">{{ tx(item.pl, item.en) }}</div>
                    <div class="stat-value">{{ item.value }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="main-card map-card">
            <div class="card-subtitle">üó∫Ô∏è {{ tx('Mapa aktywno≈õci','Activity map') }}</div>
            {% if route_payload and route_payload.has_points %}
                <div id="activityMap" class="activity-map"></div>
            {% else %}
                <div class="empty-note">{{ tx('Brak mapy dla tej aktywno≈õci.','No map available for this activity.') }}</div>
            {% endif %}
        </div>

        {% if meta_rows %}
        <div class="gym-section">
            <details class="meta-details">
                <summary>üß© {{ tx('Dodatkowe dane Garmin','Additional Garmin data') }}</summary>
                <div class="meta-grid">
                    {% for row in meta_rows %}
                    <div class="meta-row">
                        <span class="meta-key">{{ row.key }}</span>
                        <span class="meta-value">{{ row.value }}</span>
                    </div>
                    {% endfor %}
                </div>
            </details>
        </div>
        {% endif %}

        <div class="gym-section">
            <h3 class="section-title">‚úèÔ∏è {{ tx('Edytuj trening','Edit workout') }}</h3>
            <form action="/activity/{{activity.id}}/update" method="POST" class="edit-form">
                <div class="form-grid">
                    <div class="field">
                        <label>{{ tx('Typ','Type') }}</label>
                        <select name="activity_type">
                            <option value="run" {% if activity.activity_type == 'run' %}selected{% endif %}>{{ t('opt_run') }}</option>
                            <option value="ride" {% if activity.activity_type == 'ride' %}selected{% endif %}>{{ t('opt_ride') }}</option>
                            <option value="swim" {% if activity.activity_type == 'swim' %}selected{% endif %}>{{ t('opt_swim') }}</option>
                            <option value="weighttraining" {% if activity.activity_type == 'weighttraining' %}selected{% endif %}>{{ t('opt_gym') }}</option>
                            <option value="yoga" {% if activity.activity_type == 'yoga' %}selected{% endif %}>{{ t('opt_yoga') }}</option>
                            <option value="hike" {% if activity.activity_type == 'hike' %}selected{% endif %}>{{ t('opt_hike') }}</option>
                            <option value="walk" {% if activity.activity_type == 'walk' %}selected{% endif %}>{{ t('opt_walk') }}</option>
                            <option value="other" {% if activity.activity_type == 'other' %}selected{% endif %}>{{ t('opt_other') }}</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>{{ tx('Data','Date') }}</label>
                        <input type="date" name="date" value="{{ activity.start_time.strftime('%Y-%m-%d') if activity.start_time else '' }}">
                    </div>
                    <div class="field">
                        <label>{{ tx('Godzina','Time') }}</label>
                        <input type="time" name="time" value="{{ activity.start_time.strftime('%H:%M') if activity.start_time else '' }}">
                    </div>
                    <div class="field">
                        <label>{{ tx('Czas (min)','Duration (min)') }}</label>
                        <input type="text" inputmode="decimal" name="duration_min" value="{{ (activity.duration / 60)|int if activity.duration else '' }}">
                    </div>
                    <div class="field">
                        <label>{{ tx('Dystans (km)','Distance (km)') }}</label>
                        <input type="text" inputmode="decimal" name="distance_km" value="{{ (activity.distance / 1000)|round(2) if activity.distance else '' }}">
                    </div>
                    <div class="field">
                        <label>{{ tx('≈ör. tƒôtno (bpm)','Avg HR (bpm)') }}</label>
                        <input type="text" inputmode="decimal" name="avg_hr" value="{{ activity.avg_hr if activity.avg_hr else '' }}">
                    </div>
                </div>

                <div class="field field-spaced">
                    <label>{{ tx('Notatka','Notes') }}</label>
                    <textarea name="notes" placeholder="{{ tx('Jak posz≈Ço?','How did it go?') }}">{{ activity.notes or '' }}</textarea>
                </div>

                <div class="edit-actions">
                    <button type="submit" class="add-btn">{{ tx('Zapisz zmiany','Save changes') }}</button>
                </div>
            </form>
            <form id="deleteActivityForm" action="/activity/{{activity.id}}/delete" method="POST" class="delete-form">
                <button id="deleteActivityBtn" type="submit" class="del-btn">{{ tx('Usu≈Ñ trening','Delete workout') }}</button>
            </form>
        </div>

        {% if activity.activity_type in ['weighttraining', 'workout', 'crossfit', 'circuit', 'yoga'] %}
        <div class="gym-section">
            <div class="section-header-mobile">
                <h3 class="section-title gym-title">{{ tx('Dziennik ƒáwicze≈Ñ','Exercise log') }}</h3>

                {% if plans %}
                <form action="/activity/{{activity.id}}/apply_plan" method="POST" class="plan-apply-form">
                    <select name="plan_id"
                            onchange="this.form.submit()"
                            class="plan-select">
                        <option value="" disabled selected>{{ tx('üìÇ Wybierz plan...','üìÇ Choose plan...') }}</option>
                        {% for p in plans %}
                        <option value="{{p.id}}">{{p.name}}</option>
                        {% endfor %}
                    </select>
                    <noscript><button type="submit" class="add-btn">{{ tx('Wczytaj','Load') }}</button></noscript>
                </form>
                {% endif %}
            </div>

            {% if activity.exercises %}
            <div class="scroll-x">
                <table class="exercise-table">
                    <thead>
                        <tr>
                            <th width="40%">{{ tx('ƒÜwiczenie','Exercise') }}</th> <th width="15%">{{ tx('Serie','Sets') }}</th>
                            <th width="15%">{{ tx('Powt.','Reps') }}</th>
                            <th width="20%">kg</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ex in activity.exercises %}
                        <tr>
                            <td class="exercise-name-cell">
                                <span class="exercise-name">{{ ex.name }}</span>
                            </td>
                            <td><input type="number" class="edit-input" value="{{ ex.sets }}" onblur="updateEx({{ ex.id }}, 'sets', this)"></td>
                            <td><input type="number" class="edit-input" value="{{ ex.reps }}" onblur="updateEx({{ ex.id }}, 'reps', this)"></td>
                            <td><input type="number" step="0.5" class="edit-input" value="{{ ex.weight }}" placeholder="0" onblur="updateEx({{ ex.id }}, 'weight', this)"></td>
                            <td class="exercise-delete-cell">
                                <form action="/exercise/{{ex.id}}/delete" method="POST" class="inline-form">
                                    <button type="submit" class="del-btn" title="{{ tx('Usu≈Ñ','Delete') }}">&times;</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-note">
                    {{ tx('Wybierz plan powy≈ºej lub dodaj ƒáwiczenia rƒôcznie poni≈ºej.','Choose a plan above or add exercises manually below.') }}
                </div>
            {% endif %}

            <div class="add-form">
                <input type="text" id="exName" class="form-input" placeholder="{{ tx('ƒÜwiczenie','Exercise') }}">
                <input type="number" id="exSets" class="form-input" placeholder="{{ tx('Serie','Sets') }}">
                <input type="number" id="exReps" class="form-input" placeholder="{{ tx('Powt.','Reps') }}">
                <input type="number" id="exWeight" class="form-input" placeholder="kg">
                <button onclick="addExercise()" class="add-btn">+</button>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
    // Funkcja Auto-Save
    async function updateEx(id, field, inputElement) {
        const val = inputElement.value;

        // Wizualny efekt "zapisywania" (lekkie przyciemnienie)
        inputElement.style.opacity = '0.7';

        try {
            const response = await fetch(`/exercise/${id}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ [field]: val })
            });

            if (response.ok) {
                // Efekt sukcesu (zielona ramka na chwilƒô)
                inputElement.classList.add('saved');
                setTimeout(() => inputElement.classList.remove('saved'), 1000);
            } else {
                inputElement.style.borderColor = 'red';
            }
        } catch (e) {
            console.error(e);
            alert({{ tx('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem','Connection error')|tojson }});
        } finally {
            inputElement.style.opacity = '1';
        }
    }

    async function addExercise() {
        const name = document.getElementById('exName').value;
        const sets = parseInt(document.getElementById('exSets').value);
        const reps = parseInt(document.getElementById('exReps').value);
        const weight = parseFloat(document.getElementById('exWeight').value);

        if(!name || !sets || !reps) {
            alert({{ tx('Uzupe≈Çnij nazwƒô, serie i powt√≥rzenia','Fill in name, sets and reps')|tojson }});
            return;
        }

        const btn = document.querySelector('.add-form .add-btn');
        const originalText = btn.innerText;
        btn.innerText = '...';

        await fetch('/activity/{{activity.id}}/exercises', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                exercises: [{name, sets, reps, weight}]
            })
        });

        location.reload();
    }

    (function initDeleteConfirm() {
        const form = document.getElementById('deleteActivityForm');
        const btn = document.getElementById('deleteActivityBtn');
        if (!form || !btn) return;
        form.addEventListener('submit', function (e) {
            if (form.dataset.submitting === '1') {
                e.preventDefault();
                return;
            }
            const ok = confirm({{ tx('UsunƒÖƒá ten trening?', 'Delete this workout?')|tojson }});
            if (!ok) {
                e.preventDefault();
                return;
            }
            form.dataset.submitting = '1';
            btn.disabled = true;
        });
    })();
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        const routePayload = {{ route_payload|tojson }};
        if (routePayload && routePayload.has_points) {
            const points = routePayload.points || [];
            if (points.length) {
                const map = L.map('activityMap', {scrollWheelZoom: false});
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                const latlngs = points.map((p) => [p[0], p[1]]);
                if (latlngs.length === 1) {
                    map.setView(latlngs[0], 14);
                    L.marker(latlngs[0]).addTo(map);
                } else {
                    const line = L.polyline(latlngs, {color: '#ff6a00', weight: 3});
                    line.addTo(map);
                    map.fitBounds(line.getBounds(), {padding: [20, 20]});
                }
            }
        }
    </script>
    {% include "_chat_widget.html" %}
</body>
</html>
