<!DOCTYPE html>
<html>
<head>
    <title>Szczeg√≥≈Çy Aktywno≈õci</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/icons/icon-512.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-512.png">
    <link rel="stylesheet" href="/static/css/main.css">
    </head>
<body class="activity-page">
    <div class="container">
        <header>
            <div class="header-row">
                <h1>Szczeg√≥≈Çy aktywno≈õci</h1>
            </div>
            <div class="header-actions">
                <a class="btn btn-outline" href="/">Panel</a>
                <a class="btn btn-outline" href="/history">Historia</a>
            </div>
        </header>

        <div class="main-card">
            <div class="card-header header-{{activity.activity_type}} {% if activity.activity_type not in ['run','ride','swim','weighttraining', 'workout', 'walk'] %}header-default{% endif %}">
                <span class="activity-icon">
                    {% if activity.activity_type == 'run' %}üèÉ
                    {% elif activity.activity_type == 'ride' %}üö¥
                    {% elif activity.activity_type == 'swim' %}üèä
                    {% elif activity.activity_type in ['weighttraining', 'workout'] %}üèãÔ∏è
                    {% elif activity.activity_type == 'walk' %}üö∂
                    {% else %}üèÖ{% endif %}
                </span>
                <h1 class="activity-title">{{ activity_label(activity.activity_type) }}</h1>
                <div class="activity-date">{{ activity.start_time.strftime('%A, %d %B %Y') }} ‚Ä¢ {{ activity.start_time.strftime('%H:%M') }}</div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Czas trwania</div>
                    <div class="stat-value">
                        {{ activity.duration // 60 }}<span class="stat-unit">m</span>
                        {{ activity.duration % 60 }}<span class="stat-unit">s</span>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">Dystans</div>
                    <div class="stat-value">
                        {{ (activity.distance / 1000)|round(2) }}<span class="stat-unit">km</span>
                    </div>
                </div>

                {% if activity.avg_hr %}
                <div class="stat-item">
                    <div class="stat-label">≈ör. Tƒôtno</div>
                    <div class="stat-value">
                        {{ activity.avg_hr }}<span class="stat-unit">bpm</span>
                    </div>
                </div>
                {% endif %}

                {% if activity.activity_type == 'run' and activity.distance > 0 %}
                    <div class="stat-item">
                        <div class="stat-label">≈ör. Tempo</div>
                        <div class="stat-value">
                            {% set pace_decimal = (activity.duration / 60) / (activity.distance / 1000) %}
                            {% set pace_min = pace_decimal|int %}
                            {% set pace_sec = ((pace_decimal - pace_min) * 60)|int %}
                            {{ pace_min }}:{{ "%02d" % pace_sec }}<span class="stat-unit">/km</span>
                        </div>
                    </div>
                {% elif activity.activity_type == 'ride' and activity.duration > 0 %}
                    <div class="stat-item">
                        <div class="stat-label">≈ör. Prƒôdko≈õƒá</div>
                        <div class="stat-value">
                            {{ ((activity.distance / 1000) / (activity.duration / 3600))|round(1) }}<span class="stat-unit">km/h</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="gym-section">
            <h3 class="section-title">‚úèÔ∏è Edytuj trening</h3>
            <form action="/activity/{{activity.id}}/update" method="POST" class="edit-form">
                <div class="form-grid">
                    <div class="field">
                        <label>Typ</label>
                        <select name="activity_type">
                            <option value="run" {% if activity.activity_type == 'run' %}selected{% endif %}>Bieganie</option>
                            <option value="ride" {% if activity.activity_type == 'ride' %}selected{% endif %}>Rower</option>
                            <option value="swim" {% if activity.activity_type == 'swim' %}selected{% endif %}>P≈Çywanie</option>
                            <option value="weighttraining" {% if activity.activity_type == 'weighttraining' %}selected{% endif %}>Si≈Çownia</option>
                            <option value="yoga" {% if activity.activity_type == 'yoga' %}selected{% endif %}>Joga</option>
                            <option value="hike" {% if activity.activity_type == 'hike' %}selected{% endif %}>Wƒôdr√≥wka</option>
                            <option value="walk" {% if activity.activity_type == 'walk' %}selected{% endif %}>Spacer</option>
                            <option value="other" {% if activity.activity_type == 'other' %}selected{% endif %}>Inne</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Data</label>
                        <input type="date" name="date" value="{{ activity.start_time.strftime('%Y-%m-%d') if activity.start_time else '' }}">
                    </div>
                    <div class="field">
                        <label>Godzina</label>
                        <input type="time" name="time" value="{{ activity.start_time.strftime('%H:%M') if activity.start_time else '' }}">
                    </div>
                    <div class="field">
                        <label>Czas (min)</label>
                        <input type="number" name="duration_min" min="0" step="1" value="{{ (activity.duration / 60)|int if activity.duration else '' }}">
                    </div>
                    <div class="field">
                        <label>Dystans (km)</label>
                        <input type="number" name="distance_km" min="0" step="0.1" value="{{ (activity.distance / 1000)|round(2) if activity.distance else '' }}">
                    </div>
                    <div class="field">
                        <label>≈ör. tƒôtno (bpm)</label>
                        <input type="number" name="avg_hr" min="0" step="1" value="{{ activity.avg_hr if activity.avg_hr else '' }}">
                    </div>
                </div>

                <div class="field field-spaced">
                    <label>Notatka</label>
                    <textarea name="notes" placeholder="Jak posz≈Ço?">{{ activity.notes or '' }}</textarea>
                </div>

                <div class="edit-actions">
                    <button type="submit" class="add-btn">Zapisz zmiany</button>
                </div>
            </form>
            <form action="/activity/{{activity.id}}/delete" method="POST" onsubmit="return confirm('UsunƒÖƒá ten trening?')" class="delete-form">
                <button type="submit" class="del-btn">Usu≈Ñ trening</button>
            </form>
        </div>

        {% if activity.activity_type in ['weighttraining', 'workout', 'crossfit', 'circuit', 'yoga'] %}
        <div class="gym-section">
            <div class="section-header-mobile">
                <h3 class="section-title gym-title">Dziennik ƒáwicze≈Ñ</h3>

                {% if plans %}
                <form action="/activity/{{activity.id}}/apply_plan" method="POST" class="plan-apply-form">
                    <select name="plan_id"
                            onchange="this.form.submit()"
                            class="plan-select">
                        <option value="" disabled selected>üìÇ Wybierz plan...</option>
                        {% for p in plans %}
                        <option value="{{p.id}}">{{p.name}}</option>
                        {% endfor %}
                    </select>
                    <noscript><button type="submit" class="add-btn">Wczytaj</button></noscript>
                </form>
                {% endif %}
            </div>

            {% if activity.exercises %}
            <div class="scroll-x">
                <table class="exercise-table">
                    <thead>
                        <tr>
                            <th width="40%">ƒÜwiczenie</th> <th width="15%">Serie</th>
                            <th width="15%">Powt.</th>
                            <th width="20%">kg</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ex in activity.exercises %}
                        <tr>
                            <td class="exercise-name-cell">
                                <span class="exercise-name">{{ ex.name }}</span>
                            </td>
                            <td><input type="number" class="edit-input" value="{{ ex.sets }}" onblur="updateEx({{ ex.id }}, 'sets', this)"></td>
                            <td><input type="number" class="edit-input" value="{{ ex.reps }}" onblur="updateEx({{ ex.id }}, 'reps', this)"></td>
                            <td><input type="number" step="0.5" class="edit-input" value="{{ ex.weight }}" placeholder="0" onblur="updateEx({{ ex.id }}, 'weight', this)"></td>
                            <td class="exercise-delete-cell">
                                <form action="/exercise/{{ex.id}}/delete" method="POST" class="inline-form">
                                    <button type="submit" class="del-btn" title="Usu≈Ñ">&times;</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-note">
                    Wybierz plan powy≈ºej lub dodaj ƒáwiczenia rƒôcznie poni≈ºej.
                </div>
            {% endif %}

            <div class="add-form">
                <input type="text" id="exName" class="form-input" placeholder="ƒÜwiczenie">
                <input type="number" id="exSets" class="form-input" placeholder="Serie">
                <input type="number" id="exReps" class="form-input" placeholder="Powt.">
                <input type="number" id="exWeight" class="form-input" placeholder="kg">
                <button onclick="addExercise()" class="add-btn">+</button>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
    // Funkcja Auto-Save
    async function updateEx(id, field, inputElement) {
        const val = inputElement.value;

        // Wizualny efekt "zapisywania" (lekkie przyciemnienie)
        inputElement.style.opacity = '0.7';

        try {
            const response = await fetch(`/exercise/${id}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ [field]: val })
            });

            if (response.ok) {
                // Efekt sukcesu (zielona ramka na chwilƒô)
                inputElement.classList.add('saved');
                setTimeout(() => inputElement.classList.remove('saved'), 1000);
            } else {
                inputElement.style.borderColor = 'red';
            }
        } catch (e) {
            console.error(e);
            alert("B≈ÇƒÖd po≈ÇƒÖczenia z serwerem");
        } finally {
            inputElement.style.opacity = '1';
        }
    }

    async function addExercise() {
        const name = document.getElementById('exName').value;
        const sets = parseInt(document.getElementById('exSets').value);
        const reps = parseInt(document.getElementById('exReps').value);
        const weight = parseFloat(document.getElementById('exWeight').value);

        if(!name || !sets || !reps) {
            alert("Uzupe≈Çnij nazwƒô, serie i powt√≥rzenia");
            return;
        }

        const btn = document.querySelector('.add-form .add-btn');
        const originalText = btn.innerText;
        btn.innerText = '...';

        await fetch('/activity/{{activity.id}}/exercises', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                exercises: [{name, sets, reps, weight}]
            })
        });

        location.reload();
    }
    </script>
    {% include "_chat_widget.html" %}
</body>
</html>
