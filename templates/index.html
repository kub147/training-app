<!DOCTYPE html>
<html>
<head>
    <title>JWAPP</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1>{{ t('header_dashboard') }}</h1>
            </div>
            <div class="header-actions">
                                {% include "_theme_toggle.html" %}
                <a class="btn btn-outline" href="/metrics">{{ t('nav_metrics') }}</a>
                <a class="btn btn-outline" href="/profile">{{ t('nav_profile') }}</a>
                <a class="btn btn-outline" href="/plans">{{ t('nav_plans') }}</a>
                <a class="btn btn-outline" href="/logout">{{ t('nav_logout') }}</a>
            </div>
        </header>

        <div class="dashboard-grid">
            <section class="dash-main">
                <div class="card">
                    <div class="card-title">
                    <span>{{ t('roadmap_title') }}</span>
                        <div class="card-actions">
                            <button id="refreshPlanBtn" class="refresh-btn" onclick="loadPlan()">{{ t('roadmap_refresh') }}</button>
                            <span id="forecastStatus" class="mini-status" aria-live="polite"></span>
                        </div>
                    </div>

                        <div class="week-calendar" id="weekCalendar" aria-label="{{ tx('Kalendarz tygodnia','Weekly calendar') }}">
                            {% for day in week_days %}
                                <div class="week-col {% if day.is_today %}is-today{% endif %} {% if day.drop_allowed %}is-droppable{% endif %}" data-date="{{ day.date }}">
                                    <div class="week-col-head">
                                        <div>
                                            <div class="week-col-weekday">{{ day.weekday_short }}</div>
                                            <div class="week-col-date">{{ day.date }}</div>
                                        </div>
                                        {% if day.drop_allowed %}
                                            <div class="day-weather" data-weather-date="{{ day.date }}" title="{{ t('calendar_weather_loading') }}">‚Ä¶</div>
                                        {% endif %}
                                    </div>

                                    <div class="week-col-body" data-drop-date="{{ day.date }}">
                                        {% if day.card_kind == 'done' %}
                                            <button
                                                type="button"
                                                class="week-item week-item-done road-btn"
                                                data-kind="done"
                                                data-date="{{ day.date }}"
                                                data-sport="{{ day.sport }}"
                                                data-count="{{ day.done.count }}"
                                                data-dist="{{ day.done.dist_km }}"
                                                data-dur="{{ day.done.dur_min }}"
                                                data-avg-hr="{{ day.done.avg_hr if day.done.avg_hr is not none else '' }}"
                                                data-activities='{{ day.done.activities | tojson | e }}'
                                                aria-label="{{ tx('Szczeg√≥≈Çy dnia','Day details') }} {{ day.date }}"
                                            >
                                                <div class="week-item-top">
                                                    <span class="week-item-badge">{{ t('calendar_done') }}</span>
                                                </div>
                                                <div class="week-item-main">
                                                    <div class="week-item-icon">
                                                        {% if day.sport == 'run' %}üèÉ{% elif day.sport == 'ride' %}üö¥{% elif day.sport == 'swim' %}üèä{% elif day.sport in ['weighttraining','workout'] %}üèãÔ∏è{% elif day.sport == 'yoga' %}üßò{% elif day.sport == 'hike' %}‚õ∞Ô∏è{% elif day.sport == 'walk' %}üö∂{% else %}üèÖ{% endif %}
                                                    </div>
                                                    <div class="week-item-text">
                                                        <div class="week-item-title">{{ day.done.count }} {{ t('roadmap_activities') }}</div>
                                                        <div class="week-item-sub">
                                                            {{ day.done.dist_km }} km ‚Ä¢ {{ day.done.dur_min }} min
                                                            {% if day.done.avg_hr %} ‚Ä¢ HR {{ day.done.avg_hr }}{% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </button>
                                        {% elif day.card_kind == 'planned' %}
                                            <button
                                                type="button"
                                                class="week-item week-item-planned road-btn planned-item"
                                                draggable="{{ 'true' if day.drop_allowed else 'false' }}"
                                                data-kind="planned"
                                                data-date="{{ day.date }}"
                                                data-sport="{{ day.sport }}"
                                                data-intensity="{{ day.plan.intensity or '' }}"
                                                data-phase="{{ day.plan.phase or '' }}"
                                                data-goal-link="{{ (day.plan.goal_link or '') | e }}"
                                                data-warmup="{{ (day.plan.warmup or '') | e }}"
                                                data-main-set="{{ (day.plan.main_set or '') | e }}"
                                                data-cooldown="{{ (day.plan.cooldown or '') | e }}"
                                                data-workout="{{ (day.plan.workout or '') | e }}"
                                                data-why="{{ (day.plan.why or '') | e }}"
                                                data-details="{{ (day.plan.details or '') | e }}"
                                                data-dist="{{ day.plan.distance_km if day.plan.distance_km is not none else '' }}"
                                                data-dur="{{ day.plan.duration_min if day.plan.duration_min is not none else '' }}"
                                                data-source-facts='{{ (day.plan.source_facts or []) | tojson | e }}'
                                                aria-label="{{ tx('Szczeg√≥≈Çy dnia','Day details') }} {{ day.date }}"
                                            >
                                                <div class="week-item-top">
                                                    <span class="week-item-badge">{{ t('calendar_planned') }}</span>
                                                </div>
                                                <div class="week-item-main">
                                                    <div class="week-item-icon">
                                                        {% if day.sport == 'run' %}üèÉ{% elif day.sport == 'ride' %}üö¥{% elif day.sport == 'swim' %}üèä{% elif day.sport in ['weighttraining','workout'] %}üèãÔ∏è{% elif day.sport == 'yoga' %}üßò{% elif day.sport == 'hike' %}‚õ∞Ô∏è{% elif day.sport == 'walk' %}üö∂{% else %}üèÖ{% endif %}
                                                    </div>
                                                    <div class="week-item-text">
                                                        <div class="week-item-title">{{ day.plan.workout or t('label_training') }}</div>
                                                        <div class="week-item-sub">
                                                            {% if day.plan.distance_km is not none %}{{ day.plan.distance_km }} km{% endif %}
                                                            {% if day.plan.duration_min is not none %}{% if day.plan.distance_km is not none %} ‚Ä¢ {% endif %}{{ day.plan.duration_min }} min{% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </button>
                                        {% else %}
                                            <div class="week-empty">{{ t('calendar_empty') }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="week-summary-grid">
                            <div class="week-summary-card">
                                <div class="week-summary-title">{{ t('week_goals_title') }}</div>
                                {% if weekly_goal_items %}
                                    <ul class="week-goals-list">
                                        {% for line in weekly_goal_items %}
                                            <li>{{ line }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="week-summary-note">{{ t('calendar_goal_missing') }}</p>
                                {% endif %}
                                <p class="week-summary-note">
                                    {{ t('calendar_progress') }}: <b>{{ weekly_done_total }} / {{ weekly_goal_target }}</b> ({{ weekly_completion_pct }}%)
                                </p>
                            </div>

                            <div class="week-summary-card">
                                <div class="week-summary-title">{{ t('coach_note_title') }}</div>
                                <p class="week-summary-note">{{ coach_note }}</p>
                            </div>
                        </div>
                    </div>

                <div class="card">
                    <div class="card-title">{{ t('add_title') }}</div>
                    <form id="activityForm" action="/activity/manual" method="POST" enctype="multipart/form-data">
                        <div class="field">
                            <label>{{ t('label_screenshot') }}</label>
                            <input id="activity_image" type="file" name="activity_image" accept="image/*">
                        </div>
                        <div class="actions actions-row">
                            <button class="btn btn-soft" type="button" id="parseScreenshotBtn">{{ t('label_screenshot_read') }}</button>
                            <span id="parseStatus" class="mini-status" aria-live="polite"></span>
                        </div>

                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_type') }}</label>
                                <select name="activity_type" id="activity_type">
                                    <option value="run">{{ t('opt_run') }}</option>
                                    <option value="ride">{{ t('opt_ride') }}</option>
                                    <option value="swim">{{ t('opt_swim') }}</option>
                                    <option value="weighttraining">{{ t('opt_gym') }}</option>
                                    <option value="yoga">{{ t('opt_yoga') }}</option>
                                    <option value="hike">{{ t('opt_hike') }}</option>
                                    <option value="walk">{{ t('opt_walk') }}</option>
                                    <option value="other">{{ t('opt_other') }}</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>{{ t('label_date') }}</label>
                                <input id="activity_date" type="date" name="date" value="{{ today_str }}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_time') }}</label>
                                <input id="activity_time" type="time" name="time" value="">
                            </div>
                            <div class="field">
                                <label>{{ t('label_duration') }}</label>
                                <input id="duration_min" type="text" inputmode="decimal" name="duration_min" placeholder="{{ tx('np. 45 lub 45,5','e.g. 45 or 45.5') }}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_distance') }}</label>
                                <input id="distance_km" type="text" inputmode="decimal" name="distance_km" placeholder="{{ tx('np. 8,25 lub 8.25','e.g. 8.25 or 8,25') }}">
                            </div>
                            <div class="field">
                                <label>{{ t('label_avg_hr') }}</label>
                                <input id="avg_hr" type="text" inputmode="decimal" name="avg_hr" placeholder="{{ tx('np. 150','e.g. 150') }}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_avg_pace') }}</label>
                                <input id="avg_pace_min_km" type="text" inputmode="decimal" name="avg_pace_min_km" placeholder="{{ tx('np. 5,30 lub 5.30','e.g. 5.30 or 5,30') }}">
                            </div>
                            <div class="field"></div>
                        </div>

                        <div class="field field-spaced">
                            <label>{{ t('label_notes') }}</label>
                            <textarea id="activity_notes" name="notes" placeholder="{{ tx('Jak posz≈Ço? (opcjonalnie)','How did it go? (optional)') }}"></textarea>
                        </div>

                        <input type="hidden" id="parsed_applied" name="parsed_applied" value="0">

                        <div class="actions actions-row">
                            <button class="btn btn-soft btn-fixed" type="button" onclick="dictateTo('activity_notes')">{{ t('btn_speak') }}</button>
                            <button class="btn btn-grow" type="submit">{{ t('label_confirm_data') }}</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="section-header">
                        <h2 class="section-title-sm">{{ t('latest_title') }}</h2>
                        <a href="/history" class="btn btn-outline">{{ t('all_btn') }}</a>
                    </div>

                    <div class="timeline">
                        {% set current_date = namespace(value=None) %}
                        {% for act in activities %}
                            {% set act_date = act.start_time.strftime('%Y-%m-%d') %}
                            {% if current_date.value != act_date %}
                                <div class="date-header">
                                    {% if act_date == today_str %} {{ tx('DZISIAJ','TODAY') }}
                                    {% else %} {{ format_dt(act.start_time, 'list') }}
                                    {% endif %}
                                </div>
                                {% set current_date.value = act_date %}
                            {% endif %}

                            <a href="/activity/{{act.id}}" class="activity-card type-{{act.activity_type}}">
                                <div class="timeline-dot"></div>
                                <div class="act-icon">
                                    {% if act.activity_type == 'run' %}üèÉ
                                    {% elif act.activity_type == 'ride' %}üö¥
                                    {% elif act.activity_type == 'swim' %}üèä
                                    {% elif act.activity_type in ['weighttraining', 'workout'] %}üèãÔ∏è
                                    {% elif act.activity_type == 'yoga' %}üßò
                                    {% elif act.activity_type == 'hike' %}‚õ∞Ô∏è
                                    {% elif act.activity_type == 'walk' %}üö∂
                                    {% else %}üèÖ{% endif %}
                                </div>
                                <div class="act-info">
                        <div class="act-title">{{ activity_label(act.activity_type) }}</div>
                                    <div class="act-meta">
                                        {{ act.start_time.strftime('%H:%M') }}
                                        ‚Ä¢ {{ (act.duration / 60)|int }} min
                                    </div>
                                </div>
                                <div class="act-value">
                                    {% if act.distance and act.distance > 0 %}
                                        {{ (act.distance / 1000)|round(2) }} km
                                    {% else %}
                                        {{ t('label_training') }}
                                    {% endif %}
                                </div>
                            </a>
                        {% else %}
                            <p class="empty-activities">{{ t('no_activities') }}</p>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
    // --- Voice dictation ---
    function dictateTo(inputId) {
        const el = document.getElementById(inputId);
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert({{ t('speech_unsupported')|tojson }});
            return;
        }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.lang = {{ tx('pl-PL','en-US')|tojson }};
        rec.interimResults = false;
        rec.maxAlternatives = 1;

        rec.onresult = (event) => {
            const text = event.results[0][0].transcript;
            if (el.tagName.toLowerCase() === 'textarea' || el.tagName.toLowerCase() === 'input') {
                el.value = (el.value ? (el.value + " ") : "") + text;
            }
        };
        rec.onerror = () => {};
        rec.start();
    }

    async function parseScreenshotIntoForm() {
        const fileInput = document.getElementById('activity_image');
        const status = document.getElementById('parseStatus');
        const btn = document.getElementById('parseScreenshotBtn');
        const parsedApplied = document.getElementById('parsed_applied');
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
            if (status) status.textContent = {{ tx('Wybierz najpierw zdjƒôcie.', 'Choose an image first.')|tojson }};
            return;
        }

        if (btn) {
            btn.disabled = true;
            btn.classList.add('loading');
        }
        if (status) status.textContent = {{ tx('Odczytujƒô dane...', 'Reading data...')|tojson }};

        try {
            const fd = new FormData();
            fd.append('checkin_image', fileInput.files[0]);
            const res = await fetch('/api/checkin/parse', { method: 'POST', body: fd });
            const data = await res.json();
            if (!res.ok || !data || !data.ok) {
                if (status) status.textContent = (data && data.error) ? data.error : {{ t('label_screenshot_apply_fail')|tojson }};
                return;
            }

            const parsed = data.data || {};
            const setVal = (id, v) => {
                if (v === null || v === undefined || v === '') return;
                const el = document.getElementById(id);
                if (!el) return;
                el.value = v;
            };

            setVal('activity_type', parsed.activity_type);
            setVal('activity_date', parsed.date);
            setVal('activity_time', parsed.time);
            setVal('duration_min', parsed.duration_min);
            setVal('distance_km', parsed.distance_km);
            setVal('avg_hr', parsed.avg_hr);
            setVal('avg_pace_min_km', parsed.avg_pace_min_km);
            if (parsedApplied) parsedApplied.value = '1';
            if (status) status.textContent = {{ t('label_screenshot_apply_ok')|tojson }};
        } catch (e) {
            if (status) status.textContent = {{ t('label_screenshot_apply_fail')|tojson }};
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const parseBtn = document.getElementById('parseScreenshotBtn');
        if (parseBtn) parseBtn.addEventListener('click', parseScreenshotIntoForm);
    });

    async function loadPlan() {
        const btn = document.getElementById('refreshPlanBtn');
        const status = document.getElementById('forecastStatus');

        const setStatus = (txt, cls) => {
            if (!status) return;
            status.className = 'mini-status ' + (cls || '');
            status.textContent = txt || '';
        };

        if (btn) { btn.disabled = true; btn.classList.add('loading'); }
        setStatus({{ t('status_generating')|tojson }}, 'work');

        try {
            const res = await fetch('/api/forecast');
            if (!res.ok) {
                const t = await res.text();
                setStatus({{ t('status_server_error', code='__CODE__')|tojson }}.replace('__CODE__', String(res.status)), 'err');
                console.error('Forecast error:', res.status, t);
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
                return;
            }

            const data = await res.json();
            const planHtml = (data && data.plan) ? String(data.plan) : '';
            if (!planHtml) {
                setStatus({{ t('status_empty_plan')|tojson }}, 'err');
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
                return;
            }
            setStatus({{ t('status_plan_updated')|tojson }}, 'ok');
            setTimeout(() => {
                window.location.reload();
            }, 1200);
        } catch (e) {
            console.error('loadPlan exception:', e);
            setStatus({{ t('status_connection_error')|tojson }}, 'err');
        } finally {
            if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
        }
    }

    function suggestChange(dateStr, workout) {
        const input = document.getElementById('chatInput');
        if (!input) return;
        input.value = {{ tx(
            "Chcƒô zmieniƒá trening dnia __DATE__. Obecnie: __WORKOUT__. Zmie≈Ñ go proszƒô i uzasadnij.",
            "I want to change the workout for __DATE__. Current one: __WORKOUT__. Please replace it and explain why."
        )|tojson }}
            .replace('__DATE__', dateStr)
            .replace('__WORKOUT__', workout || '');
        input.focus();
        if (window.__openChatWidget) window.__openChatWidget();
    }

    function escapeHtml(s) {
      return (s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function normalizeNumber(v, suffix = '') {
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v);
      if (Number.isNaN(n)) return '';
      return `${n}${suffix}`;
    }

    async function movePlanDay(fromDate, toDate) {
      const status = document.getElementById('forecastStatus');
      const setStatus = (txt, cls) => {
        if (!status) return;
        status.className = 'mini-status ' + (cls || '');
        status.textContent = txt || '';
      };
      try {
        const res = await fetch('/api/plan/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from_date: fromDate, to_date: toDate }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          setStatus((data && data.error) || {{ t('calendar_reorder_err')|tojson }}, 'err');
          return false;
        }
        setStatus({{ t('calendar_reorder_ok')|tojson }}, 'ok');
        return true;
      } catch (_e) {
        setStatus({{ t('calendar_reorder_err')|tojson }}, 'err');
        return false;
      }
    }

    function checkHardDayConflicts() {
      const planned = Array.from(document.querySelectorAll('.planned-item'))
        .map((el) => {
          const col = el.closest('.week-col');
          return {
            date: col ? col.dataset.date : '',
            intensity: (el.dataset.intensity || '').toLowerCase(),
            workout: (el.dataset.workout || '').toLowerCase(),
          };
        })
        .filter((x) => x.date)
        .sort((a, b) => a.date.localeCompare(b.date));

      const isHard = (x) => {
        const txt = `${x.intensity} ${x.workout}`;
        return /hard|interwa|tempo|vo2|threshold|maks|max/.test(txt);
      };

      for (let i = 1; i < planned.length; i += 1) {
        if (isHard(planned[i - 1]) && isHard(planned[i])) {
          const status = document.getElementById('forecastStatus');
          if (status) {
            status.className = 'mini-status err';
            status.textContent = {{ t('calendar_swap_warning')|tojson }};
          }
          return;
        }
      }
    }

    function initCalendarModal() {
      const modal = document.getElementById('roadModal');
      const modalTitle = document.getElementById('roadModalTitle');
      const modalMeta = document.getElementById('roadModalMeta');
      const modalBody = document.getElementById('roadModalBody');
      const modalActions = document.getElementById('roadModalActions');
      const btnClose = document.getElementById('roadModalClose');
      if (!modal || !modalTitle || !modalMeta || !modalBody || !modalActions || !btnClose) return;

      function closeModal() {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
      }

      function openModal(payload) {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        const detailsLabel = {{ t('roadmap_details')|tojson }};
        modalTitle.textContent = detailsLabel + ': ' + (payload.date || '');
        modalMeta.textContent = payload.kind === 'planned' ? {{ t('calendar_planned')|tojson }} : {{ t('calendar_done')|tojson }};

        if (payload.kind === 'planned') {
          const why = payload.why ? `<p><b>{{ tx('Dlaczego','Why') }}:</b> ${escapeHtml(payload.why)}</p>` : '';
          const phase = payload.phase ? `<p><b>{{ tx('Faza','Phase') }}:</b> ${escapeHtml(payload.phase)}</p>` : '';
          const goalLink = payload.goalLink ? `<p><b>{{ tx('PowiƒÖzanie z celem','Goal link') }}:</b> ${escapeHtml(payload.goalLink)}</p>` : '';
          const warmup = payload.warmup ? `<div class="plan-step"><b>{{ t('plan_warmup') }}</b><br>${escapeHtml(payload.warmup)}</div>` : '';
          const mainSet = payload.mainSet ? `<div class="plan-step"><b>{{ t('plan_main') }}</b><br>${escapeHtml(payload.mainSet)}</div>` : '';
          const cooldown = payload.cooldown ? `<div class="plan-step"><b>{{ t('plan_cooldown') }}</b><br>${escapeHtml(payload.cooldown)}</div>` : '';
          const structured = (warmup || mainSet || cooldown) ? `<div class="plan-structured">${warmup}${mainSet}${cooldown}</div>` : '';
          const details = (payload.details && !structured)
            ? `<p><b>{{ tx('Szczeg√≥≈Çy','Details') }}:</b><br>${escapeHtml(payload.details).replaceAll('\n', '<br>')}</p>`
            : '';
          const facts = Array.isArray(payload.sourceFacts) && payload.sourceFacts.length
            ? `<p><b>{{ tx('Na podstawie','Based on') }}:</b> ${payload.sourceFacts.map((x) => escapeHtml(String(x))).join('; ')}</p>`
            : '';
          modalBody.innerHTML = `
            <p><b>{{ tx('Trening','Workout') }}:</b> ${escapeHtml(payload.workout || {{ t('label_training')|tojson }})}</p>
            <p>${normalizeNumber(payload.dist, ' km')}${payload.dist && payload.dur ? ' ‚Ä¢ ' : ''}${normalizeNumber(payload.dur, ' min')}</p>
            ${phase}
            ${goalLink}
            ${why}
            ${structured}
            ${details}
            ${facts}
          `;

          modalActions.innerHTML = '';
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'btn btn-soft btn-small';
          copyBtn.textContent = {{ t('calendar_copy_garmin')|tojson }};
          copyBtn.addEventListener('click', async () => {
            const lines = [];
            lines.push({{ tx('Trening','Workout')|tojson }} + ': ' + (payload.workout || ''));
            if (payload.warmup) lines.push({{ t('plan_warmup')|tojson }} + ': ' + payload.warmup);
            if (payload.mainSet) lines.push({{ t('plan_main')|tojson }} + ': ' + payload.mainSet);
            if (payload.cooldown) lines.push({{ t('plan_cooldown')|tojson }} + ': ' + payload.cooldown);
            if (payload.dist || payload.dur) {
              lines.push((payload.dist ? `${payload.dist} km` : '') + ((payload.dist && payload.dur) ? ' ‚Ä¢ ' : '') + (payload.dur ? `${payload.dur} min` : ''));
            }
            try {
              await navigator.clipboard.writeText(lines.filter(Boolean).join('\n'));
              const status = document.getElementById('forecastStatus');
              if (status) {
                status.className = 'mini-status ok';
                status.textContent = {{ t('calendar_copied')|tojson }};
              }
            } catch (_e) {}
          });
          modalActions.appendChild(copyBtn);

          const discussBtn = document.createElement('button');
          discussBtn.type = 'button';
          discussBtn.className = 'btn btn-soft btn-small';
          discussBtn.textContent = {{ t('calendar_discuss')|tojson }};
          discussBtn.addEventListener('click', () => {
            suggestChange(payload.date, payload.workout || '');
            closeModal();
          });
          modalActions.appendChild(discussBtn);
        } else {
          let activities = [];
          try {
            activities = JSON.parse(payload.activities || '[]');
          } catch (_e) {
            activities = [];
          }
          const rows = activities.map((a) => `
            <li>${escapeHtml(a.time || '')} ‚Ä¢ ${escapeHtml(a.label || '')} ‚Ä¢ ${normalizeNumber(a.dist_km, ' km')} ‚Ä¢ ${normalizeNumber(a.dur_min, ' min')}${a.avg_hr ? ` ‚Ä¢ HR ${a.avg_hr}` : ''}</li>
          `).join('');
          modalBody.innerHTML = `
            <p><b>{{ tx('Podsumowanie','Summary') }}:</b> ${escapeHtml(String(payload.count || 0))} {{ tx('aktywno≈õci','activities') }}</p>
            <p>${normalizeNumber(payload.dist, ' km')} ‚Ä¢ ${normalizeNumber(payload.dur, ' min')}${payload.avgHr ? ` ‚Ä¢ HR ${escapeHtml(String(payload.avgHr))}` : ''}</p>
            ${rows ? `<ul>${rows}</ul>` : ''}
          `;
          modalActions.innerHTML = '';
        }
      }

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.road-btn');
        if (!btn) return;
        const payload = {
          kind: btn.dataset.kind,
          date: btn.dataset.date,
          workout: btn.dataset.workout,
          why: btn.dataset.why,
          details: btn.dataset.details,
          phase: btn.dataset.phase,
          goalLink: btn.dataset.goalLink,
          warmup: btn.dataset.warmup,
          mainSet: btn.dataset.mainSet,
          cooldown: btn.dataset.cooldown,
          dist: btn.dataset.dist,
          dur: btn.dataset.dur,
          count: btn.dataset.count,
          avgHr: btn.dataset.avgHr,
          activities: btn.dataset.activities,
          sourceFacts: (() => {
            try { return JSON.parse(btn.dataset.sourceFacts || '[]'); } catch (_e) { return []; }
          })(),
        };
        openModal(payload);
      });

      btnClose.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) closeModal();
      });
    }

    function initProfilePromptModal() {
      const shouldShow = {{ show_profile_prompt|tojson }};
      if (!shouldShow) return;

      const modal = document.getElementById('profilePromptModal');
      const closeBtn = document.getElementById('profilePromptClose');
      const laterBtn = document.getElementById('profilePromptLater');
      if (!modal || !closeBtn || !laterBtn) return;

      const closeModal = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
      };

      closeBtn.addEventListener('click', closeModal);
      laterBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function initCalendarDnD() {
      const items = Array.from(document.querySelectorAll('.planned-item[draggable="true"]'));
      const dropZones = Array.from(document.querySelectorAll('.week-col-body'));
      let dragItem = null;
      let fromDate = null;

      items.forEach((item) => {
        item.addEventListener('dragstart', (e) => {
          dragItem = item;
          const col = item.closest('.week-col');
          fromDate = col ? col.dataset.date : null;
          e.dataTransfer.effectAllowed = 'move';
          item.classList.add('is-dragging');
        });
        item.addEventListener('dragend', () => {
          item.classList.remove('is-dragging');
          dragItem = null;
          fromDate = null;
        });
      });

      dropZones.forEach((zone) => {
        zone.addEventListener('dragover', (e) => {
          const col = zone.closest('.week-col');
          if (!col || !col.classList.contains('is-droppable')) return;
          e.preventDefault();
          zone.classList.add('is-drop-hover');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('is-drop-hover'));
        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          zone.classList.remove('is-drop-hover');
          if (!dragItem || !fromDate) return;

          const targetCol = zone.closest('.week-col');
          if (!targetCol || !targetCol.classList.contains('is-droppable')) return;
          const toDate = targetCol.dataset.date;
          if (!toDate || toDate === fromDate) return;

          const ok = await movePlanDay(fromDate, toDate);
          if (!ok) return;
          // Najbezpieczniej po zapisie od≈õwie≈ºyƒá widok z backendu (eliminuje "znikajƒÖce" kafelki).
          window.location.reload();
        });
      });
    }

    async function fetchWeatherByCoords(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('weather');
      return await res.json();
    }

    function weatherIcon(code) {
      if (code === 0) return '‚òÄÔ∏è';
      if ([1, 2].includes(code)) return 'üå§Ô∏è';
      if (code === 3) return '‚òÅÔ∏è';
      if ([45, 48].includes(code)) return 'üå´Ô∏è';
      if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return 'üåßÔ∏è';
      if ([71, 73, 75, 85, 86].includes(code)) return '‚ùÑÔ∏è';
      if ([95, 96, 99].includes(code)) return '‚õàÔ∏è';
      return 'üå°Ô∏è';
    }

    async function initWeather() {
      const weatherEls = Array.from(document.querySelectorAll('.day-weather[data-weather-date]'));
      if (!weatherEls.length) return;
      weatherEls.forEach((el) => { el.textContent = '‚Ä¶'; });

      const applyForecast = (daily) => {
        if (!daily || !daily.time) return;
        weatherEls.forEach((el) => {
          const idx = daily.time.indexOf(el.dataset.weatherDate);
          if (idx === -1) {
            el.textContent = '‚Äî';
            return;
          }
          const code = Number(daily.weather_code[idx]);
          const tMax = daily.temperature_2m_max ? Math.round(Number(daily.temperature_2m_max[idx])) : null;
          const icon = weatherIcon(code);
          el.textContent = icon;
          el.title = tMax !== null ? `${icon} ${tMax}¬∞C` : icon;
        });
      };

      const fetchByCity = async () => {
        const city = window.prompt({{ t('calendar_city_prompt')|tojson }});
        if (!city) throw new Error('city-missing');
        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language={{ tx('pl','en') }}&format=json`);
        if (!geoRes.ok) throw new Error('city-geo');
        const geo = await geoRes.json();
        if (!geo.results || !geo.results.length) throw new Error('city-not-found');
        const c = geo.results[0];
        return await fetchWeatherByCoords(c.latitude, c.longitude);
      };

      try {
        if (!navigator.geolocation) throw new Error('geo-not-supported');
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 7000, maximumAge: 1800000 });
        });
        const data = await fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
        applyForecast(data.daily);
      } catch (_e) {
        try {
          const data = await fetchByCity();
          applyForecast(data.daily);
        } catch (err2) {
          const msg = (String(err2.message || '').includes('city-not-found'))
            ? {{ t('calendar_city_not_found')|tojson }}
            : {{ t('calendar_weather_error')|tojson }};
          weatherEls.forEach((el) => {
            el.textContent = '‚Äî';
            el.title = msg;
          });
        }
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      initProfilePromptModal();
      initCalendarModal();
      initCalendarDnD();
      initWeather();
    });

// Auto-ukrywanie flash messages po 5 sekundach
document.addEventListener('DOMContentLoaded', () => {
    // Prevent accidental double-submit on slower mobile connections.
    const lockSubmit = (form) => {
        if (!form) return;
        form.addEventListener('submit', (e) => {
            if (form.dataset.submitting === '1') {
                e.preventDefault();
                return;
            }
            form.dataset.submitting = '1';
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.classList.add('loading');
            }
        });
    };
    lockSubmit(document.querySelector('form[action="/activity/manual"]'));

    const flashes = document.querySelectorAll('.flash');
    flashes.forEach(flash => {
        setTimeout(() => {
            flash.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            flash.style.opacity = '0';
            flash.style.transform = 'translateX(400px)';
            setTimeout(() => flash.remove(), 500);
        }, 5000);
    });
});
    </script>

    <!-- ROADMAP MODAL -->
    <div class="modal-backdrop" id="roadModal" aria-hidden="true">
            <div class="modal modal-wide" role="dialog" aria-modal="true" aria-labelledby="roadModalTitle">
            <div class="modal-head">
                <div>
                    <div class="modal-title" id="roadModalTitle">{{ t('roadmap_details') }}</div>
                    <div class="modal-meta" id="roadModalMeta"></div>
                </div>
                <button class="modal-close" type="button" id="roadModalClose" aria-label="{{ tx('Zamknij','Close') }}">{{ tx('Zamknij','Close') }}</button>
            </div>
            <div class="modal-body">
                <div id="roadModalBody"></div>
                <div class="modal-actions" id="roadModalActions"></div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="profilePromptModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="profilePromptTitle">
            <div class="modal-head">
                <div>
                    <div class="modal-title" id="profilePromptTitle">{{ tx('Uzupe≈Çnij profil','Complete profile') }}</div>
                    <div class="modal-meta">{{ tx('Szybkie ustawienie trenera AI','Quick AI coach setup') }}</div>
                </div>
                <button class="modal-close" type="button" id="profilePromptClose" aria-label="{{ tx('Zamknij','Close') }}">{{ tx('Zamknij','Close') }}</button>
            </div>
            <div class="modal-body">
                <p>{{ tx('Aby plan by≈Ç trafniejszy, uzupe≈Çnij cele, preferencje i ograniczenia.','To improve plan quality, add your goals, preferences and constraints.') }}</p>
                <div class="modal-actions">
                    <a class="btn" href="/onboarding">{{ tx('Uzupe≈Çnij teraz','Complete now') }}</a>
                    <button class="btn btn-soft" type="button" id="profilePromptLater">{{ tx('P√≥≈∫niej','Later') }}</button>
                </div>
            </div>
        </div>
    </div>

    {% include "_chat_widget.html" %}

</body>

<!-- Flash Messages (tu≈º po <body>) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          <div class="flash-icon">
            {% if category == 'success' %}‚úÖ
            {% elif category == 'warning' %}‚ö†Ô∏è
            {% elif category == 'error' %}‚ùå
            {% else %}‚ÑπÔ∏è{% endif %}
          </div>
          <div class="flash-text">{{ message }}</div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</html>
