<!DOCTYPE html>
<html>
<head>
    <title>JWAPP</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/icons/icon-512.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-512.png">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1>{{ t('header_dashboard') }}</h1>
            </div>
            <div class="header-actions">
                {% include "_lang_toggle.html" %}
                <a class="btn btn-outline" href="/metrics">{{ t('nav_metrics') }}</a>
                <a class="btn btn-outline" href="/profile">{{ t('nav_profile') }}</a>
                <a class="btn btn-outline" href="/plans">{{ t('nav_plans') }}</a>
                <a class="btn btn-outline" href="/logout">{{ t('nav_logout') }}</a>
            </div>
        </header>

        <div class="dashboard-grid">
            <section class="dash-main">
                <div class="card">
                    <div class="card-title">
                    <span>{{ t('roadmap_title') }}</span>
                        <div class="card-actions">
                            <button id="refreshPlanBtn" class="refresh-btn" onclick="loadPlan()">{{ t('roadmap_refresh') }}</button>
                            <span id="forecastStatus" class="mini-status" aria-live="polite"></span>
                        </div>
                    </div>

                        {# --- Zasada: unikamy duplikatu dzisiejszej daty. Je≈õli jest aktywno≈õƒá dzi≈õ -> bierzemy dzi≈õ z historii,
                           je≈õli nie ma -> bierzemy dzi≈õ z planu. --- #}
                        {% set today_has_history = (past_days | selectattr('date','equalto', today_str) | list | length) > 0 %}
                        {% set past_before = (past_days | rejectattr('date','equalto', today_str) | list) %}
                        {% set future_after = (future_days | rejectattr('date','equalto', today_str) | list) %}

                        {% if today_has_history %}
                            {% set today_item = (past_days | selectattr('date','equalto', today_str) | list | first) %}
                            {% set today_kind = 'past' %}
                        {% else %}
                            {% set today_item = (future_days | selectattr('date','equalto', today_str) | list | first) %}
                            {% set today_kind = 'future' %}
                        {% endif %}

                        {% set past_show = past_before[-3:] %}
                        {% set future_show = future_after[:3] %}

                        <div class="roadmap-board" aria-label="{{ tx('Roadmap tygodniowy','Weekly roadmap') }}">
                            <div class="roadmap-section">
                                <div class="roadmap-label">{{ t('roadmap_past') }}</div>
                                <div class="roadmap-grid">
                                    {% for d in past_show %}
                                      <button
                                          type="button"
                                          class="road-item road-btn"
                                          onclick="window.__openRoadModal && window.__openRoadModal(this)"
                                          data-kind="past"
                                          data-date="{{ d.date }}"
                                          data-sport="{{ d.sport }}"
                                          data-count="{{ d.count }}"
                                          data-dist="{{ d.dist_km }}"
                                          data-dur="{{ d.dur_min }}"
                                          aria-label="{{ tx('Szczeg√≥≈Çy dnia','Day details') }} {{ d.date }}"
                                      >
                                          <div class="road-top">
                                              <div class="road-date js-road-date">{{ d.date }}</div>
                                          </div>

                                          <div class="road-main">
                                              <div class="road-icon">
                                                  {% if d.sport == 'run' %}üèÉ{% elif d.sport == 'ride' %}üö¥{% elif d.sport == 'swim' %}üèä{% elif d.sport in ['weighttraining','workout'] %}üèãÔ∏è{% elif d.sport == 'yoga' %}üßò{% elif d.sport == 'hike' %}‚õ∞Ô∏è{% elif d.sport == 'walk' %}üö∂{% else %}üèÖ{% endif %}
                                              </div>
                                              <div class="road-text">
                                              <div class="road-title">{{ d.count }} {{ t('roadmap_activities') }}</div>
                                                  <div class="road-sub">
                                                      {% if d.dist_km and d.dist_km > 0 %}{{ d.dist_km }} km{% endif %}
                                                      {% if d.dur_min and d.dur_min > 0 %} ‚Ä¢ {{ d.dur_min }} min{% endif %}
                                                  </div>
                                              </div>
                                          </div>

                                          <div class="road-action" aria-hidden="true"><span class="pill">{{ t('roadmap_details') }}</span></div>
                                      </button>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="roadmap-section">
                                <div class="roadmap-label">{{ t('roadmap_today') }}</div>
                                <div class="roadmap-grid is-today-row">
                                    {% if today_item %}
                                      <button
                                          type="button"
                                          class="road-item road-btn is-today"
                                          onclick="window.__openRoadModal && window.__openRoadModal(this)"
                                          data-kind="{{ today_kind }}"
                                          data-date="{{ today_item.date }}"
                                          data-sport="{{ today_item.sport }}"
                                          {% if today_kind == 'past' %}
                                              data-count="{{ today_item.count }}"
                                              data-dist="{{ today_item.dist_km }}"
                                              data-dur="{{ today_item.dur_min }}"
                                          {% else %}
                                              data-workout="{{ (today_item.workout or '') | e }}"
                                              data-why="{{ (today_item.why or '') | e }}"
                                          {% endif %}
                                          aria-label="{{ tx('Szczeg√≥≈Çy dnia','Day details') }} {{ today_item.date }}"
                                      >
                                          <div class="road-top">
                                              <div class="road-date js-road-date">{{ today_item.date }}</div>
                                          <div class="today-badge">{{ t('roadmap_today_badge') }}</div>
                                          </div>

                                          <div class="road-main">
                                              <div class="road-icon">
                                                  {% if today_item.sport == 'run' %}üèÉ{% elif today_item.sport == 'ride' %}üö¥{% elif today_item.sport == 'swim' %}üèä{% elif today_item.sport in ['weighttraining','workout'] %}üèãÔ∏è{% elif today_item.sport == 'yoga' %}üßò{% elif today_item.sport == 'hike' %}‚õ∞Ô∏è{% elif today_item.sport == 'walk' %}üö∂{% else %}üèÖ{% endif %}
                                              </div>
                                              <div class="road-text">
                                                  {% if today_kind == 'past' %}
                                                      <div class="road-title">{{ today_item.count }} {{ t('roadmap_activities') }}</div>
                                                      <div class="road-sub">
                                                          {% if today_item.dist_km and today_item.dist_km > 0 %}{{ today_item.dist_km }} km{% endif %}
                                                          {% if today_item.dur_min and today_item.dur_min > 0 %} ‚Ä¢ {{ today_item.dur_min }} min{% endif %}
                                                      </div>
                                                  {% else %}
                                                      <div class="road-title">{{ today_item.workout or t('label_training') }}</div>
                                                      <div class="road-sub">{{ today_item.why or '' }}</div>
                                                  {% endif %}
                                              </div>
                                          </div>

                                          <div class="road-action" aria-hidden="true"><span class="pill">{{ t('roadmap_details') }}</span></div>
                                      </button>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="roadmap-section">
                                <div class="roadmap-label">{{ t('roadmap_next') }}</div>
                                <div class="roadmap-grid">
                                    {% for f in future_show %}
                                      <button
                                          type="button"
                                          class="road-item road-btn"
                                          onclick="window.__openRoadModal && window.__openRoadModal(this)"
                                          data-kind="future"
                                          data-date="{{ f.date }}"
                                          data-sport="{{ f.sport }}"
                                          data-workout="{{ (f.workout or '') | e }}"
                                          data-why="{{ (f.why or '') | e }}"
                                          aria-label="{{ tx('Szczeg√≥≈Çy dnia','Day details') }} {{ f.date }}"
                                      >
                                          <div class="road-top">
                                              <div class="road-date js-road-date">{{ f.date }}</div>
                                          </div>

                                          <div class="road-main">
                                              <div class="road-icon">
                                                  {% if f.sport == 'run' %}üèÉ{% elif f.sport == 'ride' %}üö¥{% elif f.sport == 'swim' %}üèä{% elif f.sport in ['weighttraining','workout'] %}üèãÔ∏è{% elif f.sport == 'yoga' %}üßò{% elif f.sport == 'hike' %}‚õ∞Ô∏è{% elif f.sport == 'walk' %}üö∂{% else %}üèÖ{% endif %}
                                              </div>
                                              <div class="road-text">
                                                  <div class="road-title">{{ f.workout or t('label_training') }}</div>
                                                  <div class="road-sub">{{ f.why or '' }}</div>
                                              </div>
                                          </div>

                                          <div class="road-action" aria-hidden="true"><span class="pill">{{ t('roadmap_details') }}</span></div>
                                      </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="card">
                    <div class="card-title">{{ t('add_title') }}</div>

                    <div class="tab-row">
                        <button class="tab active" id="tabManual" onclick="showTab('manual')">{{ t('tab_manual') }}</button>
                        <button class="tab" id="tabCheckin" onclick="showTab('checkin')">{{ t('tab_checkin') }}</button>
                    </div>

                    <div id="manualForm">
                    <form action="/activity/manual" method="POST">
                        <!-- Wiersz 1: Typ + Data (2 kolumny na desktop, 1 na mobile) -->
                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_type') }}</label>
                                <select name="activity_type">
                                <option value="run">{{ t('opt_run') }}</option>
                                <option value="ride">{{ t('opt_ride') }}</option>
                                <option value="swim">{{ t('opt_swim') }}</option>
                                <option value="weighttraining">{{ t('opt_gym') }}</option>
                                <option value="yoga">{{ t('opt_yoga') }}</option>
                                <option value="hike">{{ t('opt_hike') }}</option>
                                <option value="walk">{{ t('opt_walk') }}</option>
                                <option value="other">{{ t('opt_other') }}</option>
                            </select>
                        </div>
                            <div class="field">
                                <label>{{ t('label_date') }}</label>
                                <input type="date" name="date" value="{{ today_str }}">
                            </div>
                        </div>

                        <!-- Wiersz 2: Godzina + Czas (2 kolumny) -->
                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_time') }}</label>
                                <input type="time" name="time" value="">
                            </div>
                            <div class="field">
                                <label>{{ t('label_duration') }}</label>
                                <input type="number" name="duration_min" min="0" step="1" placeholder="{{ tx('np. 45','e.g. 45') }}">
                            </div>
                        </div>

                        <!-- Wiersz 3: Dystans (pojedyncze pole) -->
                        <div class="form-row">
                            <div class="field">
                                <label>{{ t('label_distance') }}</label>
                                <input type="number" name="distance_km" min="0" step="0.1" placeholder="{{ tx('np. 8.0','e.g. 8.0') }}">
                            </div>
                        </div>

                        <!-- Notatka -->
                        <div class="field field-spaced">
                            <label>{{ t('label_notes') }}</label>
                            <textarea name="notes" placeholder="{{ tx('Jak posz≈Ço? (opcjonalnie)','How did it go? (optional)') }}"></textarea>
                        </div>

                        <div class="actions">
                            <button class="btn" type="submit">{{ t('btn_add') }}</button>
                        </div>
                    </form>
                </div>

                <div id="checkinForm" class="is-hidden">
                        <form action="/checkin" method="POST" enctype="multipart/form-data">
                            <div class="field">
                            <label>{{ t('label_screenshot') }}</label>
                                <input type="file" name="checkin_image" accept="image/*">
                            </div>
                        <div class="field field-spaced">
                                <label>{{ t('label_checkin_desc') }}</label>
                            <textarea id="checkin_text" name="checkin_text" class="checkin-textarea" placeholder="{{ tx('Jak siƒô czu≈Çe≈õ? Co posz≈Ço dobrze/≈∫le?','How did you feel? What went well/badly?') }}"></textarea>
                        </div>
                        <div class="actions actions-row">
                            <button class="btn btn-soft btn-fixed" type="button" onclick="dictateTo('checkin_text')">{{ t('btn_speak') }}</button>
                            <button class="btn btn-grow" type="submit">{{ t('btn_save') }}</button>
                        </div>
                    </form>

                    <div class="small-note">
                        {{ t('checkin_tip') }}
                    </div>
                </div>

                </div>

                <div class="card">
                    <div class="section-header">
                        <h2 class="section-title-sm">{{ t('latest_title') }}</h2>
                        <a href="/history" class="btn btn-outline">{{ t('all_btn') }}</a>
                    </div>

                    <div class="timeline">
                        {% set current_date = namespace(value=None) %}
                        {% for act in activities %}
                            {% set act_date = act.start_time.strftime('%Y-%m-%d') %}
                            {% if current_date.value != act_date %}
                                <div class="date-header">
                                    {% if act_date == today_str %} {{ tx('DZISIAJ','TODAY') }}
                                    {% else %} {{ act.start_time.strftime('%d.%m.%Y (%A)') }}
                                    {% endif %}
                                </div>
                                {% set current_date.value = act_date %}
                            {% endif %}

                            <a href="/activity/{{act.id}}" class="activity-card type-{{act.activity_type}}">
                                <div class="timeline-dot"></div>
                                <div class="act-icon">
                                    {% if act.activity_type == 'run' %}üèÉ
                                    {% elif act.activity_type == 'ride' %}üö¥
                                    {% elif act.activity_type == 'swim' %}üèä
                                    {% elif act.activity_type in ['weighttraining', 'workout'] %}üèãÔ∏è
                                    {% elif act.activity_type == 'yoga' %}üßò
                                    {% elif act.activity_type == 'hike' %}‚õ∞Ô∏è
                                    {% elif act.activity_type == 'walk' %}üö∂
                                    {% else %}üèÖ{% endif %}
                                </div>
                                <div class="act-info">
                        <div class="act-title">{{ activity_label(act.activity_type) }}</div>
                                    <div class="act-meta">
                                        {{ act.start_time.strftime('%H:%M') }}
                                        ‚Ä¢ {{ (act.duration / 60)|int }} min
                                    </div>
                                </div>
                                <div class="act-value">
                                    {% if act.distance and act.distance > 0 %}
                                        {{ (act.distance / 1000)|round(2) }} km
                                    {% else %}
                                        {{ t('label_training') }}
                                    {% endif %}
                                </div>
                            </a>
                        {% else %}
                            <p class="empty-activities">{{ t('no_activities') }}</p>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
    // --- Tabs (quick add) ---
    function showTab(which) {
        const manual = document.getElementById('manualForm');
        const checkin = document.getElementById('checkinForm');
        const t1 = document.getElementById('tabManual');
        const t2 = document.getElementById('tabCheckin');
        if (which === 'manual') {
            manual.classList.remove('is-hidden');
            checkin.classList.add('is-hidden');
            t1.classList.add('active'); t2.classList.remove('active');
        } else {
            manual.classList.add('is-hidden');
            checkin.classList.remove('is-hidden');
            t2.classList.add('active'); t1.classList.remove('active');
        }
    }

    // --- Voice dictation ---
    function dictateTo(inputId) {
        const el = document.getElementById(inputId);
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert({{ t('speech_unsupported')|tojson }});
            return;
        }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.lang = {{ tx('pl-PL','en-US')|tojson }};
        rec.interimResults = false;
        rec.maxAlternatives = 1;

        rec.onresult = (event) => {
            const text = event.results[0][0].transcript;
            if (el.tagName.toLowerCase() === 'textarea' || el.tagName.toLowerCase() === 'input') {
                el.value = (el.value ? (el.value + " ") : "") + text;
            }
        };
        rec.onerror = () => {};
        rec.start();
    }

    async function loadPlan() {
        const btn = document.getElementById('refreshPlanBtn');
        const status = document.getElementById('forecastStatus');

        const setStatus = (txt, cls) => {
            if (!status) return;
            status.className = 'mini-status ' + (cls || '');
            status.textContent = txt || '';
        };

        if (btn) { btn.disabled = true; btn.classList.add('loading'); }
        setStatus({{ t('status_generating')|tojson }}, 'work');

        try {
            const res = await fetch('/api/forecast');
            if (!res.ok) {
                const t = await res.text();
                setStatus({{ t('status_server_error', code='__CODE__')|tojson }}.replace('__CODE__', String(res.status)), 'err');
                console.error('Forecast error:', res.status, t);
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
                return;
            }

            const data = await res.json();
            const planHtml = (data && data.plan) ? String(data.plan) : '';
            if (!planHtml) {
                setStatus({{ t('status_empty_plan')|tojson }}, 'err');
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
                return;
            }

            // Parsuj HTML planu do mapy: date -> {workout, why}
            const map = {};
            const rx = /<b>(\d{4}-\d{2}-\d{2})<\/b>\s*<br>\s*<b>\s*Trening:\s*<\/b>\s*([\s\S]*?)<br>\s*<b>\s*Dlaczego:\s*<\/b>\s*([\s\S]*?)<br>/gi;
            let m;
            while ((m = rx.exec(planHtml)) !== null) {
                const date = m[1];
                const clean = (s) => (s || '').replace(/<[^>]*>/g, '').replace(/\*\*/g, '').replace(/DATA\\s*:/gi, '').trim();
                const workout = clean(m[2]);
                const why = clean(m[3]);
                map[date] = { workout, why };
            }

            // Aktualizuj kafelki roadmapy (te, kt√≥re sƒÖ z planu)
            document.querySelectorAll('.road-btn[data-kind="future"]').forEach(btnEl => {
                const date = btnEl.dataset.date;
                const entry = map[date];
                if (!entry) return;

                btnEl.dataset.workout = entry.workout;
                btnEl.dataset.why = entry.why;

                const titleEl = btnEl.querySelector('.road-title');
                const subEl = btnEl.querySelector('.road-sub');
                if (titleEl) titleEl.textContent = entry.workout || {{ t('label_training')|tojson }};
                if (subEl) subEl.textContent = entry.why || '';
            });

            setStatus({{ t('status_plan_updated')|tojson }}, 'ok');
            setTimeout(() => setStatus('', ''), 2500);
        } catch (e) {
            console.error('loadPlan exception:', e);
            setStatus({{ t('status_connection_error')|tojson }}, 'err');
        } finally {
            if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
        }
    }

    function suggestChange(dateStr, workout) {
        const input = document.getElementById('chatInput');
        if (!input) return;
        input.value = {{ tx(
            "Chcƒô zmieniƒá trening dnia __DATE__. Obecnie: __WORKOUT__. Zmie≈Ñ go proszƒô i uzasadnij.",
            "I want to change the workout for __DATE__. Current one: __WORKOUT__. Please replace it and explain why."
        )|tojson }}
            .replace('__DATE__', dateStr)
            .replace('__WORKOUT__', workout || '');
        input.focus();
        if (window.__openChatWidget) window.__openChatWidget();
    }

    window.addEventListener('DOMContentLoaded', function(){
  (function initRoadmapModal() {
    const modal = document.getElementById('roadModal');
    const modalTitle = document.getElementById('roadModalTitle');
    const modalMeta = document.getElementById('roadModalMeta');
    const modalBody = document.getElementById('roadModalBody');
    const modalActions = document.getElementById('roadModalActions');
    const btnClose = document.getElementById('roadModalClose');

    if (!modal || !modalTitle || !modalMeta || !modalBody || !modalActions || !btnClose) {
      console.warn('Roadmap modal elements not found.');
      return;
    }

    const weekShort = {{ tx(["niedz", "pon", "wto", "sro", "czw", "pia", "sob"], ["sun", "mon", "tue", "wed", "thu", "fri", "sat"])|tojson }};

    function formatDate(isoDate) {
      // isoDate: YYYY-MM-DD
      const [y, m, d] = (isoDate || '').split('-').map(Number);
      if (!y || !m || !d) return isoDate || '';
      const dt = new Date(y, m - 1, d);
      const wd = weekShort[dt.getDay()];
      const dd = String(d).padStart(2, '0');
      const mm = String(m).padStart(2, '0');
      return `${wd} ${dd}.${mm}`;
    }

    // Podmie≈Ñ widok daty w roadmap na "pon 23.01"
    document.querySelectorAll('.js-road-date').forEach(el => {
      const raw = (el.textContent || '').trim();
      el.textContent = formatDate(raw) || raw;
    });

    let lastPayload = null;

    function openModal(payload) {
      lastPayload = payload;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');

      const pretty = formatDate(payload.date);
      modalTitle.textContent = pretty ? `{{ t('roadmap_details') }}: ${pretty}` : `{{ t('roadmap_details') }}`;
      modalMeta.textContent = payload.date || '';

      modalActions.innerHTML = '';

      if (payload.kind === 'future') {
        const workout = cleanPlanText(payload.workout || {{ t('label_training')|tojson }});
        const why = cleanPlanText(payload.why || '');

        modalBody.innerHTML = `
          <p><b>{{ tx('Trening','Workout') }}:</b> ${escapeHtml(workout)}</p>
          ${why ? `<p><b>{{ tx('Dlaczego','Why') }}:</b> ${escapeHtml(why)}</p>` : `<p class="muted">{{ t('modal_no_reason') }}</p>`}
        `;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-soft btn-small';
        btn.textContent = {{ tx('Zaproponuj zmianƒô','Suggest change')|tojson }};
        btn.addEventListener('click', () => {
          if (typeof suggestChange === 'function') {
            suggestChange(payload.date, workout);
            closeModal();
          }
        });
        modalActions.appendChild(btn);
      } else {
        const count = payload.count ?? '0';
        const dist = payload.dist ?? '0';
        const dur = payload.dur ?? '0';
        modalBody.innerHTML = `
          <p><b>{{ tx('Podsumowanie','Summary') }}:</b></p>
          <p>${escapeHtml(String(count))} {{ tx('aktywno≈õci','activities') }}</p>
          <p>${escapeHtml(String(dist))} km ‚Ä¢ ${escapeHtml(String(dur))} min</p>
        `;
      }
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      lastPayload = null;
    }

    function cleanPlanText(s) {
      const t = (s ?? '').toString();
      return t
        .replace(/\*\*DATA\*\*\s*:\s*/gi, '')
        .replace(/\bDATA\s*:\s*/gi, '')
        .trim();
    }

    function escapeHtml(s) {
      return (s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.road-btn');
      if (!btn) return;

      const payload = {
        kind: btn.dataset.kind,
        date: btn.dataset.date,
        sport: btn.dataset.sport,
        workout: btn.dataset.workout,
        why: btn.dataset.why,
        count: btn.dataset.count,
        dist: btn.dataset.dist,
        dur: btn.dataset.dur,
      };
      openModal(payload);
    });

    btnClose.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      // klik w t≈Ço zamyka
      if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('open')) closeModal();
    });
  })()
});;

// Auto-ukrywanie flash messages po 5 sekundach
document.addEventListener('DOMContentLoaded', () => {
    const flashes = document.querySelectorAll('.flash');
    flashes.forEach(flash => {
        setTimeout(() => {
            flash.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            flash.style.opacity = '0';
            flash.style.transform = 'translateX(400px)';
            setTimeout(() => flash.remove(), 500);
        }, 5000);
    });
});
    </script>

    <!-- ROADMAP MODAL -->
    <div class="modal-backdrop" id="roadModal" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="roadModalTitle">
            <div class="modal-head">
                <div>
                    <div class="modal-title" id="roadModalTitle">{{ t('roadmap_details') }}</div>
                    <div class="modal-meta" id="roadModalMeta"></div>
                </div>
                <button class="modal-close" type="button" id="roadModalClose" aria-label="{{ tx('Zamknij','Close') }}">{{ tx('Zamknij','Close') }}</button>
            </div>
            <div class="modal-body">
                <p id="roadModalBody"></p>
                <div class="modal-actions" id="roadModalActions"></div>
            </div>
        </div>
    </div>

    {% include "_chat_widget.html" %}

</body>

<!-- Flash Messages (tu≈º po <body>) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          <div class="flash-icon">
            {% if category == 'success' %}‚úÖ
            {% elif category == 'warning' %}‚ö†Ô∏è
            {% elif category == 'error' %}‚ùå
            {% else %}‚ÑπÔ∏è{% endif %}
          </div>
          <div class="flash-text">{{ message }}</div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</html>
