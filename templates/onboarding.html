<!DOCTYPE html>
<html>
<head>
    <title>{{ tx('Uzupe≈Çnij profil','Complete profile') }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
<div class="container">
    <header>
        <div class="header-row">
            <h1>üß† {{ tx('Uzupe≈Çnij profil','Complete profile') }}</h1>
        </div>
        <div class="header-actions">
                            {% include "_theme_toggle.html" %}
            <a class="btn btn-outline" href="/logout">{{ t('nav_logout') }}</a>
        </div>
    </header>

    <p class="page-sub">
        {{ tx('To jest pierwszy krok po rejestracji. Pytania sƒÖ bardziej ‚Äûotwarte‚Äù ‚Äî model trenera bierze pod uwagƒô nie tylko liczby, ale i kontekst.','This is the first step after registration. Questions are more open-ended ‚Äî the coach model uses not only numbers but context too.') }}
        {{ tx('Dane mo≈ºesz p√≥≈∫niej edytowaƒá w zak≈Çadce','You can edit this data later in') }} <b>{{ tx('Profil','Profile') }}</b>.
    </p>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for m in messages %}
          <div class="flash info">{{ m }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="/onboarding">
        <div class="card">
            <div class="section-title">{{ tx('FAKTY (jak wyglƒÖda Twoja baza)','FACTS (your baseline)') }}</div>
            <div class="help-text">{{ tx('Te informacje sƒÖ wzglƒôdnie sta≈Çe ‚Äî edytujesz je, gdy co≈õ realnie siƒô zmienia.','These values are relatively stable ‚Äî update when something really changes.') }}</div>

            <div class="field">
                <label>{{ tx('1) Jakie dyscypliny trenujesz? (np. run, ride, swim, gym)','1) Which disciplines do you train? (e.g. run, ride, swim, gym)') }}</label>
                <input type="text" name="primary_sports" placeholder="{{ tx('np. run, gym','e.g. run, gym') }}" value="{{ profile.primary_sports or '' }}">
            </div>

            <div class="form-row">
                <div class="field">
                    <label>{{ tx('2) Ile czasu realnie masz tygodniowo? (h)','2) How much time do you realistically have weekly? (h)') }}</label>
                    <input type="text" inputmode="decimal" name="weekly_time_hours" value="{{ profile.weekly_time_hours if profile.weekly_time_hours is not none else '' }}" placeholder="{{ tx('np. 5 lub 5,5','e.g. 5 or 5.5') }}">
                </div>
                <div class="field">
                    <label>{{ tx('3) Ile dni w tygodniu mo≈ºesz trenowaƒá?','3) How many days per week can you train?') }}</label>
                    <input type="number" min="1" max="7" name="days_per_week" value="{{ profile.days_per_week if profile.days_per_week is not none else '' }}" placeholder="{{ tx('np. 4','e.g. 4') }}">
                </div>
            </div>

            <div class="section-title">{{ tx('Preferowana liczba sesji / tydzie≈Ñ','Preferred sessions / week') }}</div>
            <div class="help-text">{{ tx('To bƒôdƒÖ sta≈Çe cele tygodnia na panelu (zrealizowane / docelowe).','These become stable weekly goals on the dashboard (done / target).') }}</div>
            <div class="field">
                <label>{{ tx('Jakie sporty chcesz mieƒá w celach tygodnia?','Which sports do you want in weekly goals?') }}</label>
                <div class="sport-pick-grid">
                    {% for sport in target_sport_keys %}
                        <label class="sport-pick-item">
                            <input type="checkbox" name="weekly_focus_sports" value="{{ sport }}" {% if sport in focus_sports %}checked{% endif %}>
                            <span>{{ activity_label(sport) }}</span>
                        </label>
                    {% endfor %}
                </div>
                <div class="help-text">{{ tx('Wybierz minimum 1 sport (je≈õli nic nie wybierzesz, ustawimy bieganie).','Pick at least 1 sport (if empty, running will be selected).') }}</div>
            </div>
            <div class="form-row">
                {% for sport in target_sport_keys %}
                    <div class="field weekly-target-field {% if sport not in focus_sports %}is-hidden{% endif %}" data-sport-field="{{ sport }}">
                        <label>{{ activity_label(sport) }} / {{ tx('tydzie≈Ñ','week') }}</label>
                        <input type="number" min="0" max="14" name="{{ target_sport_fields[sport] }}" value="{{ target_values.get(sport, '') }}" placeholder="{{ tx('np. 2','e.g. 2') }}">
                    </div>
                {% endfor %}
            </div>

            <div class="form-row">
                <div class="field">
                    <label>{{ tx('Styl trenera','Coach style') }}</label>
                    <select name="coach_style">
                        <option value="">{{ tx('zbalansowany','balanced') }}</option>
                        <option value="concise">{{ tx('kr√≥tko i konkretnie','concise') }}</option>
                        <option value="motivating">{{ tx('motywujƒÖco','motivating') }}</option>
                        <option value="technical">{{ tx('technicznie','technical') }}</option>
                    </select>
                </div>
                <div class="field">
                    <label>{{ tx('Tolerancja ryzyka','Risk tolerance') }}</label>
                    <select name="risk_tolerance">
                        <option value="balanced">{{ tx('zbalansowana','balanced') }}</option>
                        <option value="conservative">{{ tx('konserwatywna','conservative') }}</option>
                        <option value="aggressive">{{ tx('agresywna','aggressive') }}</option>
                    </select>
                </div>
            </div>

            <div class="field">
                <label>{{ tx('Priorytet treningu','Training priority') }}</label>
                <select name="training_priority">
                    <option value="performance">{{ tx('wynik','performance') }}</option>
                    <option value="consistency">{{ tx('regularno≈õƒá','consistency') }}</option>
                    <option value="health">{{ tx('zdrowie','health') }}</option>
                </select>
            </div>

            <div class="form-row">
                <div class="field">
                    <label>{{ tx('4) Ile km tygodniowo biegasz / je≈∫dzisz (je≈õli dotyczy)?','4) Weekly run/ride distance (if applicable)?') }}</label>
                    <input type="text" inputmode="decimal" name="weekly_distance_km" value="{{ profile.weekly_distance_km if profile.weekly_distance_km is not none else '' }}" placeholder="{{ tx('np. 30,5 lub 30.5','e.g. 30.5 or 30,5') }}">
                </div>
                <div class="field">
                    <label>{{ tx('5) Co mo≈ºesz powiedzieƒá o swoim do≈õwiadczeniu?','5) What can you say about your experience?') }}</label>
                    <input type="text" name="experience_text" value="{{ profile.experience_text or '' }}" placeholder="{{ tx('np. biegam 2 lata, wracam po przerwie','e.g. running for 2 years, coming back after a break') }}">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">{{ tx('CELE (dokƒÖd zmierzasz)','GOALS (where you are heading)') }}</div>
            <div class="field">
                <label>{{ tx('6) Jaki jest Tw√≥j g≈Ç√≥wny cel? (napisz normalnie)','6) What is your main goal? (write naturally)') }}</label>
                <textarea class="textarea-lg" name="goals_text">{{ profile.goals_text or '' }}</textarea>
            </div>
            <div class="form-row">
                <div class="field">
                    <label>{{ tx('7) Wydarzenie docelowe (opcjonalnie)','7) Target event (optional)') }}</label>
                    <input type="text" name="target_event" value="{{ profile.target_event or '' }}" placeholder="{{ tx('np. p√≥≈Çmaraton','e.g. half marathon') }}">
                </div>
                <div class="field">
                    <label>{{ tx('8) Data docelowa (opcjonalnie)','8) Target date (optional)') }}</label>
                    <input type="date" name="target_date" value="{{ profile.target_date.isoformat() if profile.target_date else '' }}">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">{{ tx('Preferencje i ograniczenia','Preferences and constraints') }}</div>
            <div class="field">
                <label>{{ tx('9) Co lubisz / czego nie lubisz w treningu?','9) What do you like / dislike in training?') }}</label>
                <textarea class="textarea-lg" name="preferences_text">{{ profile.preferences_text or '' }}</textarea>
            </div>
            <div class="field">
                <label>{{ tx('10) Ograniczenia (czas, sprzƒôt, praca, dojazdy)','10) Constraints (time, equipment, work, commute)') }}</label>
                <textarea class="textarea-lg" name="constraints_text">{{ profile.constraints_text or '' }}</textarea>
            </div>
        </div>

        <div class="card">
            <div class="section-title">{{ tx('STAN (czasowo wra≈ºliwe)','STATE (time-sensitive)') }}</div>
            <div class="help-text">{{ tx('To jest ‚Äûstan na teraz‚Äù (np. uraz). Aplikacja traktuje to jako aktualne tylko przez okre≈õlony czas.','This is your ‚Äúcurrent state‚Äù (e.g., injury). The app treats it as valid for a limited time.') }}</div>

            <div class="field">
                <label>{{ tx('11) Czy masz teraz uraz / b√≥l / ograniczenie? (opcjonalnie)','11) Do you currently have an injury / pain / limitation? (optional)') }}</label>
                <textarea class="textarea-lg" name="injuries_text" placeholder="{{ tx('np. lekki b√≥l kolana od tygodnia','e.g. mild knee pain for a week') }}"></textarea>
            </div>

            <div class="field dictation-wrap">
                <label>{{ tx('12) Kr√≥tki kontekst (mo≈ºe byƒá g≈Çosowo) ‚Äî co jest dla Ciebie wa≈ºne?','12) Short context (voice allowed) ‚Äî what matters most to you?') }}</label>
                <button type="button" class="mic-btn" data-target="context">{{ tx('üé§ M√≥w','üé§ Speak') }}</button>
                <textarea class="textarea-lg" id="context" name="context_text" placeholder="{{ tx('Np. jak Ci siƒô trenuje, co Ciƒô mƒôczy, co chcesz poprawiƒá...','E.g. how training feels, what tires you, what you want to improve...') }}"></textarea>
                <div class="help-text">{{ tx('Wspierane w Chrome/Edge (Web Speech API). Je≈õli nie dzia≈Ça, wpisz rƒôcznie.','Supported in Chrome/Edge (Web Speech API). If unavailable, type manually.') }}</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" type="submit">{{ tx('Zapisz i przejd≈∫ do panelu','Save and go to dashboard') }}</button>
        </div>
    </form>
</div>

<script>
(function(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const micButtons = document.querySelectorAll('.mic-btn');

  if(!SpeechRecognition){
    micButtons.forEach(b => { b.disabled = true; b.title = {{ tx('Brak wsparcia Web Speech API w tej przeglƒÖdarce','Web Speech API is not supported in this browser')|tojson }}; });
    return;
  }

  micButtons.forEach(btn => {
    const targetId = btn.getAttribute('data-target');
    const ta = document.getElementById(targetId);

    const recognition = new SpeechRecognition();
    recognition.lang = {{ tx('pl-PL','en-US')|tojson }};
    recognition.interimResults = true;
    recognition.continuous = true;

    let finalText = '';

    recognition.onresult = (event) => {
      let interim = '';
      for(let i=event.resultIndex;i<event.results.length;i++){
        const transcript = event.results[i][0].transcript;
        if(event.results[i].isFinal){
          finalText += transcript + ' ';
        } else {
          interim += transcript;
        }
      }
      ta.value = (finalText + interim).trim();
    };

    recognition.onerror = () => {
      btn.classList.remove('active');
      btn.textContent = {{ tx('üé§ M√≥w','üé§ Speak')|tojson }};
    };

    recognition.onend = () => {
      btn.classList.remove('active');
      btn.textContent = {{ tx('üé§ M√≥w','üé§ Speak')|tojson }};
    };

    btn.addEventListener('click', () => {
      if(btn.classList.contains('active')){
        recognition.stop();
        return;
      }
      btn.classList.add('active');
      btn.textContent = {{ tx('‚èπ Stop','‚èπ Stop')|tojson }};
      try { recognition.start(); } catch(e) { /* ignore */ }
    });
  });
})();

(function(){
  const boxes = Array.from(document.querySelectorAll('input[name="weekly_focus_sports"]'));
  const fields = Array.from(document.querySelectorAll('.weekly-target-field'));
  if(!boxes.length || !fields.length) return;

  const sync = () => {
    const selected = new Set(boxes.filter(b => b.checked).map(b => b.value));
    fields.forEach(el => {
      const sport = el.getAttribute('data-sport-field');
      const active = selected.has(sport);
      el.classList.toggle('is-hidden', !active);
      const input = el.querySelector('input');
      if(input && !active){
        input.value = '0';
      }
    });
  };

  boxes.forEach(box => box.addEventListener('change', sync));
  sync();
})();
</script>

{% include "_chat_widget.html" %}
</body>
</html>
